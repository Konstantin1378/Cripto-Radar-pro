<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Liquidation Tracker Pro</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #4361ee;
    --primary-dark: #3a56d4;
    --secondary: #f72585;
    --success: #06d6a0;
    --danger: #ef476f;
    --warning: #ffd166;
    --dark: #121826;
    --dark-light: #1e293b;
    --light: #f8fafc;
    --light-dark: #e2e8f0;
    --text-dark: #e2e8f0;
    --text-light: #1e293b;
    --card-bg: rgba(30, 41, 59, 0.6);
    --card-bg-light: rgba(248, 250, 252, 0.8);
    --border: #334155;
    --border-light: #cbd5e1;
    --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.25), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
    --heatmap-high: #ef476f;
    --heatmap-medium: #ff9e00;
    --heatmap-low: #06d6a0;
    --long-color: #06d6a0;
    --short-color: #ef476f;
    --glass: rgba(30, 41, 59, 0.5);
    --glass-light: rgba(248, 250, 252, 0.6);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, var(--dark) 0%, #0f172a 100%);
    color: var(--text-dark);
    margin: 0;
    padding: 0;
    transition: var(--transition);
    min-height: 100vh;
    line-height: 1.6;
    overflow-x: hidden;
    position: relative;
  }

  body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 10% 20%, rgba(67, 97, 238, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(247, 37, 133, 0.1) 0%, transparent 20%);
    z-index: -1;
  }

  body.light {
    background: linear-gradient(135deg, var(--light) 0%, #e2e8f0 100%);
    color: var(--text-light);
  }

  body.light::before {
    background: radial-gradient(circle at 10% 20%, rgba(67, 97, 238, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(247, 37, 133, 0.05) 0%, transparent 20%);
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 0;
    margin-bottom: 20px;
    position: relative;
    z-index: 10;
    flex-wrap: wrap;
    gap: 15px;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 15px;
    position: relative;
    overflow: hidden;
  }

  .logo-icon {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    width: 50px;
    height: 50px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow);
    transition: var(--transition);
    z-index: 2;
  }

  .logo-icon::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
    border-radius: 14px;
  }

  .logo-icon i {
    font-size: 24px;
    color: white;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
  }

  .logo-text {
    font-size: 26px;
    font-weight: 800;
    background: linear-gradient(to right, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -0.5px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .header-controls {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
  }

  .symbol-navigation {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .current-symbol {
    font-weight: 700;
    font-size: 18px;
    min-width: 100px;
    text-align: center;
  }

  .symbol-nav-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary-dark);
    border: none;
    cursor: pointer;
    transition: var(--transition);
  }

  .symbol-nav-btn:hover {
    transform: scale(1.1);
    background: var(--primary);
  }

  .control-panel {
    background: var(--glass);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.05);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }

  .control-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(255,255,255,0.05), transparent);
    pointer-events: none;
  }

  body.light .control-panel {
    background: var(--glass-light);
    border: 1px solid rgba(0,0,0,0.05);
  }

  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .panel-title {
    font-size: 22px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
    background: linear-gradient(to right, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .panel-title i {
    font-size: 24px;
  }

  .controls-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .control-label {
    font-size: 15px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-dark);
  }

  body.light .control-label {
    color: var(--text-light);
  }

  select, input, button {
    padding: 14px 18px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--dark-light);
    color: var(--text-dark);
    font-size: 16px;
    font-weight: 500;
    outline: none;
    transition: var(--transition);
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  body.light select,
  body.light input,
  body.light button {
    background: var(--light-dark);
    color: var(--text-light);
    border: 1px solid var(--border-light);
  }

  select:focus, input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.3);
    transform: translateY(-1px);
  }

  button {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-weight: 600;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(67, 97, 238, 0.2);
  }

  button::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(rgba(255,255,255,0.2), transparent);
    pointer-events: none;
  }

  button:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(67, 97, 238, 0.3);
  }

  button:active {
    transform: translateY(0);
  }

  button.secondary {
    background: transparent;
    border: 1px solid var(--primary);
    color: var(--primary);
    box-shadow: none;
  }

  button.secondary:hover {
    background: rgba(67, 97, 238, 0.15);
  }

  #symbolSearch {
    width: 100%;
  }

  #symbolSelect {
    width: 100%;
    height: 150px;
  }

  .stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
  }

  .stat-card {
    background: var(--glass);
    border-radius: 20px;
    padding: 25px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
    display: flex;
    flex-direction: column;
    gap: 15px;
    border: 1px solid rgba(255,255,255,0.05);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(255,255,255,0.03), transparent);
    pointer-events: none;
  }

  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.3);
  }

  body.light .stat-card {
    background: var(--glass-light);
    border: 1px solid rgba(0,0,0,0.05);
  }

  .stat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .stat-title {
    font-size: 16px;
    font-weight: 600;
    opacity: 0.9;
    color: var(--text-dark);
  }

  body.light .stat-title {
    color: var(--text-light);
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(67, 97, 238, 0.15);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
  }

  .stat-icon i {
    color: var(--primary);
    font-size: 20px;
  }

  .stat-value {
    font-size: 32px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(to right, var(--text-dark), #94a3b8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  body.light .stat-value {
    background: linear-gradient(to right, var(--text-light), #64748b);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .ratio-display {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
  }

  .ratio-bar {
    flex-grow: 1;
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    overflow: hidden;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
  }

  body.light .ratio-bar {
    background: var(--border-light);
  }

  .long-ratio {
    height: 100%;
    background: var(--long-color);
    transition: width 0.5s ease;
  }

  .ratio-text {
    font-size: 15px;
    font-weight: 600;
    min-width: 50px;
    text-align: right;
  }

  .data-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
    margin-bottom: 25px;
  }

  @media (max-width: 992px) {
    .data-container {
      grid-template-columns: 1fr;
    }
  }

  .chart-container, .table-container {
    background: var(--glass);
    border-radius: 20px;
    padding: 25px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.05);
    transition: var(--transition);
  }

  .chart-container:hover, .table-container:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.25);
  }

  body.light .chart-container,
  body.light .table-container {
    background: var(--glass-light);
    border: 1px solid rgba(0,0,0,0.05);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
  }

  .section-title {
    font-size: 20px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-dark);
  }

  body.light .section-title {
    color: var(--text-light);
  }

  .section-title i {
    color: var(--primary);
  }

  canvas {
    width: 100% !important;
    height: 300px !important;
  }

  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    table-layout: fixed;
  }

  thead {
    position: sticky;
    top: 0;
    z-index: 10;
  }

  th, td {
    padding: 16px;
    text-align: left;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    border-bottom: 1px solid var(--border);
    transition: var(--transition);
  }

  body.light th,
  body.light td {
    border-bottom: 1px solid var(--border-light);
  }

  th {
    font-weight: 700;
    font-size: 15px;
    color: var(--primary);
    cursor: pointer;
    user-select: none;
    position: relative;
    background: rgba(30, 41, 59, 0.8);
    backdrop-filter: blur(5px);
  }

  body.light th {
    background: rgba(248, 250, 252, 0.8);
  }

  th:hover {
    background: rgba(67, 97, 238, 0.15);
  }

  th.sort-asc::after {
    content: " ↑";
    font-weight: bold;
  }

  th.sort-desc::after {
    content: " ↓";
    font-weight: bold;
  }

  tr:nth-child(even) {
    background-color: rgba(255, 255, 255, 0.03);
  }

  body.light tr:nth-child(even) {
    background-color: rgba(0, 0, 0, 0.03);
  }

  tr.large-volume {
    font-weight: bold;
    background: rgba(239, 71, 111, 0.1) !important;
    position: relative;
  }

  tr.large-volume::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--danger);
  }

  /* Анимация для крупных ликвидаций */
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(239, 71, 111, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(239, 71, 111, 0); }
    100% { box-shadow: 0 0 0 0 rgba(239, 71, 111, 0); }
  }

  .large-liquidation {
    animation: pulse 2s;
    position: relative;
  }

  .large-liquidation::after {
    content: "🔥";
    position: absolute;
    right: 10px;
    font-size: 18px;
  }

  .trend-indicator {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
    margin-top: 5px;
  }

  .trend-up { color: var(--success); }
  .trend-down { color: var(--danger); }

  .status {
    text-align: center;
    padding: 18px;
    margin-bottom: 20px;
    border-radius: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow);
    transition: var(--transition);
  }

  .status.connected {
    background: rgba(6, 214, 160, 0.15);
    color: var(--success);
    border: 1px solid rgba(6, 214, 160, 0.2);
  }

  .status.connecting {
    background: rgba(255, 209, 102, 0.15);
    color: var(--warning);
    border: 1px solid rgba(255, 209, 102, 0.2);
  }

  .status.error {
    background: rgba(239, 71, 111, 0.15);
    color: var(--danger);
    border: 1px solid rgba(239, 71, 111, 0.2);
  }

  .footer {
    text-align: center;
    padding: 25px;
    font-size: 14px;
    opacity: 0.7;
    margin-top: 20px;
    border-top: 1px solid var(--border);
    backdrop-filter: blur(5px);
    border-radius: 14px;
    transition: var(--transition);
  }

  body.light .footer {
    border-top: 1px solid var(--border-light);
  }

  .filter-controls {
    display: flex;
    gap: 20px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255,255,255,0.05);
    padding: 12px 18px;
    border-radius: 12px;
    transition: var(--transition);
  }

  body.light .filter-group {
    background: rgba(0,0,0,0.03);
  }

  .filter-group:hover {
    background: rgba(67, 97, 238, 0.1);
    transform: translateY(-2px);
  }

  .heatmap-container {
    margin-top: 25px;
  }

  .heatmap-title {
    font-size: 17px;
    font-weight: 600;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-dark);
  }

  body.light .heatmap-title {
    color: var(--text-light);
  }

  .heatmap {
    display: flex;
    height: 36px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: var(--shadow);
    border: 1px solid rgba(255,255,255,0.05);
  }

  .heatmap-bar {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    color: #000;
    transition: all 0.5s ease;
  }

  .alert-controls {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-top: 20px;
    padding: 15px;
    background: rgba(255,255,255,0.05);
    border-radius: 14px;
    flex-wrap: wrap;
  }

  body.light .alert-controls {
    background: rgba(0,0,0,0.03);
  }

  .alert-toggle {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
  }

  .alert-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .alert-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--border);
    transition: .4s;
    border-radius: 34px;
  }

  .alert-slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  input:checked + .alert-slider {
    background-color: var(--success);
  }

  input:checked + .alert-slider:before {
    transform: translateX(26px);
  }

  /* Language selector */
  .language-selector {
    position: relative;
    display: inline-block;
  }
  
  .language-btn {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border: none;
    border-radius: 12px;
    padding: 12px 20px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: var(--transition);
    box-shadow: 0 4px 6px rgba(67, 97, 238, 0.2);
  }
  
  .language-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(67, 97, 238, 0.3);
  }
  
  .language-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 10px;
    background: var(--dark-light);
    border-radius: 12px;
    box-shadow: var(--shadow);
    overflow: hidden;
    z-index: 100;
    display: none;
    width: 200px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .language-dropdown.show {
    display: block;
  }
  
  .language-option {
    padding: 14px 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .language-option:hover {
    background: rgba(67, 97, 238, 0.2);
  }
  
  .language-option.active {
    background: rgba(67, 97, 238, 0.3);
  }
  
  .flag {
    font-size: 20px;
  }
  
  body.light .language-dropdown {
    background: var(--light-dark);
    border: 1px solid rgba(0,0,0,0.1);
  }
  
  body.light .language-option:hover {
    background: rgba(67, 97, 238, 0.1);
  }
  
  body.light .language-option.active {
    background: rgba(67, 97, 238, 0.15);
  }

  /* Hint styles */
  .hint {
    background: rgba(255, 209, 102, 0.15);
    color: var(--warning);
    border: 1px solid rgba(255, 209, 102, 0.2);
    text-align: center;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow);
    transition: var(--transition);
  }

  body.light .hint {
    background: rgba(255, 209, 102, 0.3);
  }

  /* Liquidity map */
  .liquidity-map-container {
    margin-top: 25px;
  }

  .liquidity-map {
    display: flex;
    flex-direction: column;
    gap: 2px;
    height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
  }

  .liquidity-level {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    border-radius: 8px;
    background: var(--glass);
  }

  .level-price {
    width: 120px;
    font-weight: 600;
    font-family: 'Courier New', monospace;
  }

  .level-bar {
    flex-grow: 1;
    height: 20px;
    margin: 0 15px;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
  }

  .level-fill {
    height: 100%;
    transition: width 0.5s ease;
  }

  .level-volume {
    width: 120px;
    text-align: right;
    font-family: 'Courier New', monospace;
  }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .container > * {
    animation: fadeIn 0.6s ease-out forwards;
  }

  .stat-card:nth-child(1) { animation-delay: 0.1s; }
  .stat-card:nth-child(2) { animation-delay: 0.2s; }
  .stat-card:nth-child(3) { animation-delay: 0.3s; }
  .stat-card:nth-child(4) { animation-delay: 0.4s; }
  .stat-card:nth-child(5) { animation-delay: 0.5s; }
  .chart-container { animation-delay: 0.2s; }
  .table-container { animation-delay: 0.3s; }

  /* Добавлен новый стиль для ячеек с ценой */
  .price-cell {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    letter-spacing: -0.3px;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .header {
      flex-direction: column;
      gap: 20px;
      align-items: flex-start;
    }
    
    .header-controls {
      width: 100%;
      justify-content: space-between;
    }
    
    .controls-grid {
      grid-template-columns: 1fr;
    }
    
    .stats-cards {
      grid-template-columns: 1fr;
    }
    
    .filter-controls {
      flex-direction: column;
      gap: 10px;
    }
    
    .stat-value {
      font-size: 28px;
    }
    
    .logo-text {
      font-size: 22px;
    }
    
    .panel-title {
      font-size: 20px;
    }
    
    .section-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .section-title {
      font-size: 18px;
    }
    
    .table-container table {
      display: block;
      overflow-x: auto;
    }
    
    .language-dropdown {
      width: 100%;
      left: 0;
      right: auto;
    }
    
    .language-btn {
      width: 100%;
      justify-content: center;
    }
    
    button {
      padding: 12px 15px;
      font-size: 14px;
    }
    
    .control-group select,
    .control-group input {
      padding: 12px 15px;
      font-size: 14px;
    }
    
    th, td {
      padding: 12px;
      font-size: 14px;
    }
    
    .stat-card {
      padding: 20px;
    }
    
    .control-panel {
      padding: 20px;
    }
    
    .footer {
      padding: 15px;
    }

    .symbol-navigation {
      margin-top: 15px;
      width: 100%;
      justify-content: center;
    }
  }
  
  @media (max-width: 480px) {
    .logo-text {
      font-size: 20px;
    }
    
    .panel-title {
      font-size: 18px;
    }
    
    .stat-value {
      font-size: 26px;
    }
    
    .chart-container,
    .table-container {
      padding: 18px;
    }
    
    .alert-controls {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .language-btn {
      padding: 10px 15px;
    }
    
    .header-controls {
      gap: 10px;
    }
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo">
      <div class="logo-icon">
        <i class="fas fa-bolt"></i>
      </div>
      <div class="logo-text" id="appTitle">Liquidation Tracker Pro</div>
    </div>
    
    <div class="header-controls">
      <div class="symbol-navigation">
        <button class="symbol-nav-btn" id="prevSymbol">
          <i class="fas fa-chevron-left"></i>
        </button>
        <div class="current-symbol" id="currentSymbol">-</div>
        <button class="symbol-nav-btn" id="nextSymbol">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      
      <div class="language-selector">
        <button class="language-btn" id="languageBtn">
          <span class="flag" id="currentFlag">🇺🇸</span>
          <span id="currentLanguage">English</span>
          <i class="fas fa-chevron-down"></i>
        </button>
        <div class="language-dropdown" id="languageDropdown">
          <div class="language-option" data-lang="en">
            <span class="flag">🇺🇸</span>
            <span>English</span>
          </div>
          <div class="language-option" data-lang="ru">
            <span class="flag">🇷🇺</span>
            <span>Русский</span>
          </div>
          <div class="language-option" data-lang="uk">
            <span class="flag">🇺🇦</span>
            <span>Українська</span>
          </div>
        </div>
      </div>
      
      <button id="themeBtn">
        <i class="fas fa-moon"></i>
        <span id="themeText">Light Theme</span>
      </button>
    </div>
  </div>

  <div class="status" id="status">
    <i class="fas fa-spinner fa-spin"></i>
    <span id="statusText">Loading symbols...</span>
  </div>

  <div class="hint" id="hint" style="display: none;">
    <i class="fas fa-info-circle"></i>
    <span id="hintText"></span>
  </div>

  <div class="control-panel">
    <div class="panel-header">
      <div class="panel-title">
        <i class="fas fa-tachometer-alt"></i>
        <span id="controlsTitle">Controls Dashboard</span>
      </div>
    </div>
    
    <div class="controls-grid">
      <div class="control-group">
        <label class="control-label">
          <i class="fas fa-search"></i>
          <span id="searchLabel">Search symbol</span>
        </label>
        <input type="text" id="symbolSearch" placeholder="BTC, ETH, SOL..." />
      </div>
      
      <div class="control-group">
        <label class="control-label">
          <i class="fas fa-coins"></i>
          <span id="selectLabel">Select symbol</span>
        </label>
        <select id="symbolSelect" size="5"></select>
      </div>
      
      <div class="control-group">
        <label class="control-label">
          <i class="fas fa-filter"></i>
          <span id="volumeLabel">Minimum volume (USD)</span>
        </label>
        <input type="number" id="minVolume" value="1000" min="0" step="100" />
      </div>
      
      <div class="control-group">
        <label class="control-label">
          <i class="fas fa-clock"></i>
          <span id="timeframeLabel">Timeframe</span>
        </label>
        <select id="timeframeSelect">
          <option value="1" id="time1">1 minute</option>
          <option value="5" selected id="time5">5 minutes</option>
          <option value="15" id="time15">15 minutes</option>
          <option value="60" id="time60">1 hour</option>
        </select>
      </div>
      
      <div class="control-group">
        <label class="control-label">
          <i class="fas fa-cog"></i>
          <span id="actionsLabel">Actions</span>
        </label>
        <div style="display: flex; gap: 10px;">
          <button id="pauseBtn">
            <i class="fas fa-pause"></i>
            <span id="pauseText">Pause</span>
          </button>
          <button class="secondary" id="clearBtn">
            <i class="fas fa-trash"></i>
            <span id="clearText">Clear</span>
          </button>
        </div>
      </div>
      
      <div class="control-group">
        <label class="control-label">
          <i class="fas fa-exclamation-triangle"></i>
          <span id="thresholdLabel">Large Liquidation Threshold ($)</span>
        </label>
        <input type="number" id="largeThreshold" value="10000" min="0" step="1000" />
      </div>

      <div class="control-group">
        <label class="control-label">
          <i class="fas fa-calculator"></i>
          <span id="calcLabel">Liquidation Calculator</span>
        </label>
        <div style="display: grid; gap: 10px; grid-template-columns: 1fr 1fr;">
          <input type="number" id="entryPrice" placeholder="Entry price">
          <input type="number" id="leverage" placeholder="Leverage (1-100)" min="1" max="100" value="10">
          <select id="positionType">
            <option value="long">Long</option>
            <option value="short">Short</option>
          </select>
          <button id="calculateBtn">
            <i class="fas fa-calculator"></i>
            <span id="calcText">Calculate</span>
          </button>
        </div>
        <div id="calcResult" style="margin-top: 10px; font-weight: 600;"></div>
      </div>
    </div>
    
    <div class="alert-controls">
      <label class="control-label">
        <i class="fas fa-bell"></i>
        <span id="alertLabel">Alerts for large liquidations</span>
      </label>
      <label class="alert-toggle">
        <input type="checkbox" id="alertToggle">
        <span class="alert-slider"></span>
      </label>
    </div>
    
    <div class="filter-controls">
      <div class="filter-group">
        <input type="checkbox" id="showLongs" checked>
        <label for="showLongs" id="showLongsLabel">Show Long Liquidations</label>
      </div>
      <div class="filter-group">
        <input type="checkbox" id="showShorts" checked>
        <label for="showShorts" id="showShortsLabel">Show Short Liquidations</label>
      </div>
    </div>
  </div>

  <div class="stats-cards">
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-title" id="totalVolumeTitle">Total Volume</div>
        <div class="stat-icon">
          <i class="fas fa-chart-pie"></i>
        </div>
      </div>
      <div class="stat-value" id="totalVolume">$0</div>
      <div class="trend-indicator" id="totalVolumeTrend">
        <i class="fas fa-arrow-up trend-up"></i>
        <span class="trend-value">0%</span>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-title" id="buyVolumeTitle">Buy Volume</div>
        <div class="stat-icon">
          <i class="fas fa-arrow-trend-up"></i>
        </div>
      </div>
      <div class="stat-value" id="buyVolume">$0</div>
      <div class="trend-indicator" id="buyVolumeTrend">
        <i class="fas fa-arrow-up trend-up"></i>
        <span class="trend-value">0%</span>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-title" id="sellVolumeTitle">Sell Volume</div>
        <div class="stat-icon">
          <i class="fas fa-arrow-trend-down"></i>
        </div>
      </div>
      <div class="stat-value" id="sellVolume">$0</div>
      <div class="trend-indicator" id="sellVolumeTrend">
        <i class="fas fa-arrow-up trend-up"></i>
        <span class="trend-value">0%</span>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-title" id="largeLiquidationsTitle">Large Liquidations</div>
        <div class="stat-icon">
          <i class="fas fa-fire"></i>
        </div>
      </div>
      <div class="stat-value" id="largeLiquidations">0</div>
      <div class="ratio-display">
        <div class="ratio-text" id="ratioLabel">Long/Short Ratio</div>
        <div class="ratio-bar">
          <div class="long-ratio" id="longRatioBar" style="width: 50%"></div>
        </div>
        <div class="ratio-text" id="longRatioText">50%</div>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-title" id="oiTitle">Open Interest</div>
        <div class="stat-icon">
          <i class="fas fa-chart-network"></i>
        </div>
      </div>
      <div class="stat-value" id="openInterest">$0</div>
      <div class="trend-indicator" id="oiChange">
        <i class="fas fa-arrow-up trend-up"></i>
        <span class="trend-value">0%</span>
      </div>
    </div>
  </div>

  <!-- Карта ликвидности перенесена сюда (выше графика и таблицы) -->
  <div class="chart-container liquidity-map-container">
    <div class="section-header">
      <div class="section-title">
        <i class="fas fa-map"></i>
        <span id="liquidityTitle">Liquidity Heatmap</span>
      </div>
    </div>
    <div class="liquidity-map" id="liquidityMap"></div>
  </div>

  <div class="data-container">
    <div class="chart-container">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-chart-line"></i>
          <span id="chartTitle">Volume Chart</span>
        </div>
      </div>
      <canvas id="chart"></canvas>
      
      <div class="heatmap-container">
        <div class="heatmap-title">
          <i class="fas fa-fire"></i>
          <span id="heatmapTitle">Liquidation Heatmap (Last 15 intervals)</span>
        </div>
        <div class="heatmap" id="heatmap"></div>
      </div>
    </div>
    
    <div class="table-container">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-table-list"></i>
          <span id="tableTitle">Liquidation Events</span>
        </div>
        <button class="secondary" id="exportBtn">
          <i class="fas fa-file-export"></i>
          <span id="exportText">Export CSV</span>
        </button>
      </div>
      <table>
        <thead>
          <tr>
            <th data-sort="time" id="timeHeader">Time</th>
            <th data-sort="type" id="typeHeader">Type</th>
            <th data-sort="price" id="priceHeader">Price</th>
            <th data-sort="volume" id="volumeHeader">Volume</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    <p id="footerText">Liquidation Tracker Pro v3.0 &copy; 2025 | Data provided by Binance WebSocket</p>
  </div>
</div>

<audio id="alertSound">
  <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
</audio>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Current language
  const translations = {
    en: {
      appTitle: "Liquidation Tracker Pro",
      themeText: "Light Theme",
      controlsTitle: "Controls Dashboard",
      searchLabel: "Search symbol",
      selectLabel: "Select symbol",
      volumeLabel: "Minimum volume (USD)",
      timeframeLabel: "Timeframe",
      time1: "1 minute",
      time5: "5 minutes",
      time15: "15 minutes",
      time60: "1 hour",
      actionsLabel: "Actions",
      resumeText: "Resume",
      pauseText: "Pause",
      clearText: "Clear",
      thresholdLabel: "Large Liquidation Threshold ($)",
      alertLabel: "Alerts for large liquidations",
      showLongsLabel: "Show Long Liquidations",
      showShortsLabel: "Show Short Liquidations",
      totalVolumeTitle: "Total Volume",
      buyVolumeTitle: "Buy Volume",
      sellVolumeTitle: "Sell Volume",
      largeLiquidationsTitle: "Large Liquidations",
      ratioLabel: "Long/Short Ratio",
      chartTitle: "Volume Chart",
      heatmapTitle: "Liquidation Heatmap (Last 15 intervals)",
      tableTitle: "Liquidation Events",
      exportText: "Export CSV",
      timeHeader: "Time",
      typeHeader: "Type",
      priceHeader: "Price",
      volumeHeader: "Volume",
      footerText: "Liquidation Tracker Pro v3.0 &copy; 2025 | Data provided by Binance WebSocket",
      loadingSymbols: "Loading symbols...",
      connecting: "Connecting to Binance",
      connected: "Connected to Binance",
      reconnecting: "Reconnecting in 3 seconds...",
      connectionError: "Connection error:",
      noSymbols: "No symbols found",
      exportError: "No data to export",
      longLiq: "Long Liq",
      shortLiq: "Short Liq",
      alertTitle: "Large Liquidation Alert",
      hintText: "After selecting token, reload the page",
      calcLabel: "Liquidation Calculator",
      calcText: "Calculate",
      oiTitle: "Open Interest",
      liquidityTitle: "Liquidity Heatmap",
      liquidationPrice: "Liquidation Price:",
      invalidInput: "Please enter valid numbers",
      calcInstructions: "Enter entry price and leverage to calculate liquidation price"
    },
    ru: {
      appTitle: "Трекер Ликвидаций Про",
      themeText: "Светлая тема",
      controlsTitle: "Панель управления",
      searchLabel: "Поиск символа",
      selectLabel: "Выбор символа",
      volumeLabel: "Минимальный объем (USD)",
      timeframeLabel: "Временной интервал",
      time1: "1 минута",
      time5: "5 минут",
      time15: "15 минут",
      time60: "1 час",
      actionsLabel: "Действия",
      resumeText: "Продолжить",
      pauseText: "Пауза",
      clearText: "Очистить",
      thresholdLabel: "Порог крупной ликвидации ($)",
      alertLabel: "Оповещения для крупных ликвидаций",
      showLongsLabel: "Показывать длинные ликвидации",
      showShortsLabel: "Показывать короткие ликвидации",
      totalVolumeTitle: "Общий объем",
      buyVolumeTitle: "Объем покупок",
      sellVolumeTitle: "Объем продаж",
      largeLiquidationsTitle: "Крупные ликвидации",
      ratioLabel: "Соотношение Long/Short",
      chartTitle: "График объема",
      heatmapTitle: "Карта ликвидаций (последние 15 интервалов)",
      tableTitle: "События ликвидаций",
      exportText: "Экспорт CSV",
      timeHeader: "Время",
      typeHeader: "Тип",
      priceHeader: "Цена",
      volumeHeader: "Объем",
      footerText: "Трекер Ликвидаций Про v3.0 &copy; 2025 | Данные предоставлены Binance WebSocket",
      loadingSymbols: "Загрузка символов...",
      connecting: "Подключение к Binance",
      connected: "Подключено к Binance",
      reconnecting: "Переподключение через 3 секунды...",
      connectionError: "Ошибка подключения:",
      noSymbols: "Символы не найдены",
      exportError: "Нет данных для экспорта",
      longLiq: "Лонг Ликв",
      shortLiq: "Шорт Ликв",
      alertTitle: "Оповещение о крупной ликвидации",
      hintText: "После выбора токена перезагрузи страницу",
      calcLabel: "Калькулятор ликвидаций",
      calcText: "Рассчитать",
      oiTitle: "Открытый интерес",
      liquidityTitle: "Карта ликвидности",
      liquidationPrice: "Цена ликвидации:",
      invalidInput: "Пожалуйста, введите корректные числа",
      calcInstructions: "Введите цену входа и кредитное плечо для расчета цены ликвидации"
    },
    uk: {
      appTitle: "Трекер Ліквідацій Про",
      themeText: "Світла тема",
      controlsTitle: "Панель управління",
      searchLabel: "Пошук символу",
      selectLabel: "Вибір символу",
      volumeLabel: "Мінімальний об'єм (USD)",
      timeframeLabel: "Часовий інтервал",
      time1: "1 хвилина",
      time5: "5 хвилин",
      time15: "15 хвилин",
      time60: "1 година",
      actionsLabel: "Дії",
      resumeText: "Продовжити",
      pauseText: "Пауза",
      clearText: "Очистити",
      thresholdLabel: "Поріг великої ліквідації ($)",
      alertLabel: "Оповіщення для великих ліквідацій",
      showLongsLabel: "Показувати довгі ліквідації",
      showShortsLabel: "Показувати короткі ліквідації",
      totalVolumeTitle: "Загальний об'єм",
      buyVolumeTitle: "Об'єм покупок",
      sellVolumeTitle: "Об'єм продажів",
      largeLiquidationsTitle: "Великі ліквідації",
      ratioLabel: "Співвідношення Long/Short",
      chartTitle: "Графік об'єму",
      heatmapTitle: "Карта ліквідацій (останні 15 інтервалів)",
      tableTitle: "Події ліквідацій",
      exportText: "Експорт CSV",
      timeHeader: "Час",
      typeHeader: "Тип",
      priceHeader: "Ціна",
      volumeHeader: "Об'єм",
      footerText: "Трекер Ліквідацій Про v3.0 &copy; 2025 | Дані надані Binance WebSocket",
      loadingSymbols: "Завантаження символів...",
      connecting: "Підключення до Binance",
      connected: "Підключено до Binance",
      reconnecting: "Перепідключення через 3 секунди...",
      connectionError: "Помилка підключення:",
      noSymbols: "Символи не знайдені",
      exportError: "Немає даних для експорту",
      longLiq: "Лонг Лікв",
      shortLiq: "Шорт Лікв",
      alertTitle: "Оповіщення про велику ліквідацію",
      hintText: "Після вибору токена перезавантаж сторінку",
      calcLabel: "Калькулятор ліквідацій",
      calcText: "Розрахувати",
      oiTitle: "Відкритий інтерес",
      liquidityTitle: "Карта ліквідності",
      liquidationPrice: "Ціна ліквідації:",
      invalidInput: "Будь ласка, введіть коректні числа",
      calcInstructions: "Введіть ціну входу та кредитне плече для розрахунку ціни ліквідації"
    }
  };

  // Конфигурация
  const MAX_EVENTS = 500;
  const HEATMAP_SIZE = 15;
  const MAX_EVENTS_PER_SECOND = 50;
  let currentLanguage = 'en';
  let allSymbols = [];
  let totalVolume = 0;
  let buyVolume = 0;
  let sellVolume = 0;
  let largeLiquidations = 0;
  let longLiquidations = 0;
  let shortLiquidations = 0;
  let events = [];
  let prevTotalVolume = 0;
  let prevBuyVolume = 0;
  let prevSellVolume = 0;
  let prevOpenInterest = 0;
  let eventCounter = 0;
  let lastReset = Date.now();
  let currentSymbolIndex = 0;

  // DOM elements
  const statusElement = document.getElementById('status');
  const statusTextElement = document.getElementById('statusText');
  const symbolSelect = document.getElementById("symbolSelect");
  const minVolumeInput = document.getElementById("minVolume");
  const timeframeSelect = document.getElementById("timeframeSelect");
  const tableBody = document.getElementById("tableBody");
  const chartCtx = document.getElementById("chart").getContext("2d");
  const symbolSearch = document.getElementById("symbolSearch");
  const pauseBtn = document.getElementById("pauseBtn");
  const themeBtn = document.getElementById("themeBtn");
  const clearBtn = document.getElementById("clearBtn");
  const largeThresholdInput = document.getElementById("largeThreshold");
  const showLongsCheckbox = document.getElementById("showLongs");
  const showShortsCheckbox = document.getElementById("showShorts");
  const alertToggle = document.getElementById("alertToggle");
  const alertSound = document.getElementById("alertSound");
  const exportBtn = document.getElementById("exportBtn");
  const longRatioBar = document.getElementById("longRatioBar");
  const longRatioText = document.getElementById("longRatioText");
  const heatmap = document.getElementById("heatmap");
  const languageBtn = document.getElementById("languageBtn");
  const languageDropdown = document.getElementById("languageDropdown");
  const currentFlag = document.getElementById("currentFlag");
  const currentLanguageText = document.getElementById("currentLanguage");
  const hintElement = document.getElementById("hint");
  const hintTextElement = document.getElementById("hintText");
  const prevSymbolBtn = document.getElementById("prevSymbol");
  const nextSymbolBtn = document.getElementById("nextSymbol");
  const currentSymbolElement = document.getElementById("currentSymbol");
  const entryPriceInput = document.getElementById("entryPrice");
  const leverageInput = document.getElementById("leverage");
  const positionTypeSelect = document.getElementById("positionType");
  const calculateBtn = document.getElementById("calculateBtn");
  const calcResultElement = document.getElementById("calcResult");
  const openInterestElement = document.getElementById("openInterest");
  const oiChangeElement = document.getElementById("oiChange");
  const liquidityMapElement = document.getElementById("liquidityMap");
  const totalVolumeTrendElement = document.getElementById("totalVolumeTrend");
  const buyVolumeTrendElement = document.getElementById("buyVolumeTrend");
  const sellVolumeTrendElement = document.getElementById("sellVolumeTrend");
  
  // Stats elements
  const totalVolumeElement = document.getElementById("totalVolume");
  const buyVolumeElement = document.getElementById("buyVolume");
  const sellVolumeElement = document.getElementById("sellVolume");
  const largeLiquidationsElement = document.getElementById("largeLiquidations");

  // App state
  let socket;
  let buffer = [];
  let paused = false;
  let chart;
  let currentTimeframe = 5;
  let intervalTimer = null;
  let currentIntervalStart = null;
  let sortField = "time";
  let sortDirection = "desc";
  let heatmapData = [];
  let openInterest = 0;

  // Apply language to UI
  function applyLanguage(lang) {
    currentLanguage = lang;
    const t = translations[lang];

    // Update UI elements
    document.getElementById('appTitle').textContent = t.appTitle;
    document.getElementById('themeText').textContent = t.themeText;
    document.getElementById('controlsTitle').textContent = t.controlsTitle;
    document.getElementById('searchLabel').textContent = t.searchLabel;
    document.getElementById('selectLabel').textContent = t.selectLabel;
    document.getElementById('volumeLabel').textContent = t.volumeLabel;
    document.getElementById('timeframeLabel').textContent = t.timeframeLabel;
    document.getElementById('time1').textContent = t.time1;
    document.getElementById('time5').textContent = t.time5;
    document.getElementById('time15').textContent = t.time15;
    document.getElementById('time60').textContent = t.time60;
    document.getElementById('actionsLabel').textContent = t.actionsLabel;
    document.getElementById('pauseText').textContent = paused ? t.resumeText : t.pauseText;
    document.getElementById('clearText').textContent = t.clearText;
    document.getElementById('thresholdLabel').textContent = t.thresholdLabel;
    document.getElementById('alertLabel').textContent = t.alertLabel;
    document.getElementById('showLongsLabel').textContent = t.showLongsLabel;
    document.getElementById('showShortsLabel').textContent = t.showShortsLabel;
    document.getElementById('totalVolumeTitle').textContent = t.totalVolumeTitle;
    document.getElementById('buyVolumeTitle').textContent = t.buyVolumeTitle;
    document.getElementById('sellVolumeTitle').textContent = t.sellVolumeTitle;
    document.getElementById('largeLiquidationsTitle').textContent = t.largeLiquidationsTitle;
    document.getElementById('ratioLabel').textContent = t.ratioLabel;
    document.getElementById('chartTitle').textContent = t.chartTitle;
    document.getElementById('heatmapTitle').textContent = t.heatmapTitle;
    document.getElementById('tableTitle').textContent = t.tableTitle;
    document.getElementById('exportText').textContent = t.exportText;
    document.getElementById('timeHeader').textContent = t.timeHeader;
    document.getElementById('typeHeader').textContent = t.typeHeader;
    document.getElementById('priceHeader').textContent = t.priceHeader;
    document.getElementById('volumeHeader').textContent = t.volumeHeader;
    document.getElementById('footerText').textContent = t.footerText;
    hintTextElement.textContent = t.hintText;
    document.getElementById('calcLabel').textContent = t.calcLabel;
    document.getElementById('calcText').textContent = t.calcText;
    document.getElementById('oiTitle').textContent = t.oiTitle;
    document.getElementById('liquidityTitle').textContent = t.liquidityTitle;
    calcResultElement.textContent = t.calcInstructions;

    // Update current language display
    if (lang === 'en') {
      currentFlag.textContent = '🇺🇸';
      currentLanguageText.textContent = 'English';
    } else if (lang === 'ru') {
      currentFlag.textContent = '🇷🇺';
      currentLanguageText.textContent = 'Русский';
    } else if (lang === 'uk') {
      currentFlag.textContent = '🇺🇦';
      currentLanguageText.textContent = 'Українська';
    }
    
    // Re-render table to update text
    renderTable();

    // Save language preference
    localStorage.setItem("language", lang);
  }

  // Update status display
  function updateStatus(text, isError = false) {
    statusTextElement.textContent = text;
    statusElement.className = 'status';
    
    if (isError) {
      statusElement.classList.add('error');
    } else if (text.includes('Connecting') || text.includes('Loading') || text.includes('Reconnecting')) {
      statusElement.classList.add('connecting');
    } else {
      statusElement.classList.add('connected');
    }
  }

  // Initialize chart
  function initializeChart() {
    if(chart) chart.destroy();
    return new Chart(chartCtx, {
      type: "bar",
      data: {
        labels: [],
        datasets: [
          {
            label: translations[currentLanguage].longLiq,
            backgroundColor: "rgba(239, 71, 111, 0.7)",
            data: [],
            borderRadius: 6,
            borderSkipped: false,
          },
          {
            label: translations[currentLanguage].shortLiq,
            backgroundColor: "rgba(6, 214, 160, 0.7)",
            data: [],
            borderRadius: 6,
            borderSkipped: false,
          },
          {
            label: "Price",
            type: "line",
            data: [],
            borderColor: "rgba(67, 97, 238, 1)",
            backgroundColor: "rgba(67, 97, 238, 0.1)",
            yAxisID: "y1",
            fill: true,
            pointRadius: 0,
            tension: 0.4
          }
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 500 },
        scales: {
          x: {
            stacked: true,
            grid: {
              color: 'rgba(255,255,255,0.1)'
            },
            ticks: {
              color: 'rgba(255,255,255,0.7)'
            }
          },
          y: {
            stacked: true,
            beginAtZero: true,
            grid: {
              color: 'rgba(255,255,255,0.1)'
            },
            ticks: {
              color: 'rgba(255,255,255,0.7)',
              callback: function(value) {
                return '$' + value;
              }
            }
          },
          y1: {
            position: 'right',
            grid: { drawOnChartArea: false },
            ticks: { color: 'rgba(67, 97, 238, 0.8)' }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: '#e0e0e0',
              font: {
                weight: 'bold'
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(30, 41, 59, 0.9)',
            titleColor: '#f8fafc',
            bodyColor: '#e2e8f0',
            borderColor: 'rgba(67, 97, 238, 0.5)',
            borderWidth: 1,
            padding: 12,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': $' + context.parsed.y.toFixed(0);
              }
            }
          }
        }
      },
    });
  }

  // Update stats cards
  function updateStats() {
    totalVolumeElement.textContent = '$' + formatNumber(Math.round(totalVolume));
    buyVolumeElement.textContent = '$' + formatNumber(Math.round(buyVolume));
    sellVolumeElement.textContent = '$' + formatNumber(Math.round(sellVolume));
    largeLiquidationsElement.textContent = largeLiquidations;
    openInterestElement.textContent = '$' + formatNumber(Math.round(openInterest));

    // Update long/short ratio
    const total = longLiquidations + shortLiquidations;
    const longRatio = total > 0 ? Math.round((longLiquidations / total) * 100) : 50;
    longRatioBar.style.width = longRatio + '%';
    longRatioText.textContent = longRatio + '%';

    // Update trends
    updateTrends();
  }
  
  // Format large numbers
  function formatNumber(num) {
    if (num >= 1000000) {
      return (num / 1000000).toFixed(2) + 'M';
    } else if (num >= 1000) {
      return (num / 1000).toFixed(1) + 'K';
    }
    return num.toLocaleString();
  }

  // Update trends
  function updateTrends() {
    updateTrend(totalVolume, prevTotalVolume, totalVolumeTrendElement);
    updateTrend(buyVolume, prevBuyVolume, buyVolumeTrendElement);
    updateTrend(sellVolume, prevSellVolume, sellVolumeTrendElement);
    updateTrend(openInterest, prevOpenInterest, oiChangeElement);
    
    // Save current values for next comparison
    prevTotalVolume = totalVolume;
    prevBuyVolume = buyVolume;
    prevSellVolume = sellVolume;
    prevOpenInterest = openInterest;
  }

  function updateTrend(currentValue, previousValue, element) {
    if (previousValue === 0 || currentValue === previousValue) {
      element.innerHTML = '<i class="fas fa-minus"></i> <span class="trend-value">0%</span>';
      return;
    }
    
    const change = ((currentValue - previousValue) / previousValue * 100).toFixed(2);
    const isPositive = change >= 0;
    
    element.innerHTML = `
      <i class="fas fa-arrow-${isPositive ? 'up' : 'down'} trend-${isPositive ? 'up' : 'down'}"></i>
      <span class="trend-value">${Math.abs(change)}%</span>
    `;
  }

  // Update chart with new data
  function updateChart(longs, shorts, price) {
    const now = new Date();
    const label = now.toLocaleTimeString();
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(longs);
    chart.data.datasets[1].data.push(shorts);
    
    if (price) {
      chart.data.datasets[2].data.push(price);
    }
    
    if (chart.data.labels.length > HEATMAP_SIZE) {
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
      chart.data.datasets[1].data.shift();
      chart.data.datasets[2].data.shift();
    }
    
    chart.update();
    
    // Update heatmap
    heatmapData.push(longs + shorts);
    if (heatmapData.length > HEATMAP_SIZE) heatmapData.shift();
    updateHeatmap();
  }

  // Update heatmap visualization
  function updateHeatmap() {
    heatmap.innerHTML = '';
    if (heatmapData.length === 0) return;
    
    const maxValue = Math.max(...heatmapData);
    const minValue = Math.min(...heatmapData);
    const range = maxValue - minValue || 1; // Avoid division by zero
    
    heatmapData.forEach(value => {
      const normalized = (value - minValue) / range;
      let color;
      let intensity;
      
      if (normalized < 0.3) {
        color = 'var(--heatmap-low)';
        intensity = 'Low';
      } else if (normalized < 0.7) {
        color = 'var(--heatmap-medium)';
        intensity = 'Medium';
      } else {
        color = 'var(--heatmap-high)';
        intensity = 'High';
      }
      
      const bar = document.createElement('div');
      bar.className = 'heatmap-bar';
      bar.style.background = color;
      bar.style.flex = '1';
      bar.title = `$${Math.round(value).toLocaleString()} - ${intensity} Intensity`;
      heatmap.appendChild(bar);
    });
  }

  // Start aggregation interval
  function startAggregationInterval(timeframe) {
    clearTimeout(intervalTimer);
    currentTimeframe = timeframe;
    currentIntervalStart = Date.now();
    intervalTimer = setTimeout(() => aggregateBuffer(), currentTimeframe * 60000);
  }

  // Aggregate buffer data based on timeframe
  function aggregateBuffer() {
    if (paused) {
      buffer = [];
      return;
    }
    
    const endInterval = currentIntervalStart + currentTimeframe * 60000;
    const eventsInInterval = buffer.filter(event => 
      event.timestamp >= currentIntervalStart && event.timestamp < endInterval
    );
    buffer = buffer.filter(event => 
      !(event.timestamp >= currentIntervalStart && event.timestamp < endInterval)
    );

    let longs = 0;
    let shorts = 0;
    let lastPrice = 0;

    eventsInInterval.forEach((event) => {
      if (event.type === translations[currentLanguage].longLiq) {
        longs += event.volume;
      } else {
        shorts += event.volume;
      }
      lastPrice = event.price;
    });

    if (longs + shorts > 0) {
      totalVolume += longs + shorts;
      buyVolume += shorts; // Short liquidations are buy orders
      sellVolume += longs; // Long liquidations are sell orders
      updateChart(longs, shorts, lastPrice);
      updateStats();
    }
    
    currentIntervalStart = endInterval;
    intervalTimer = setTimeout(() => aggregateBuffer(), currentTimeframe * 60000);
  }

  // Add event to table
  function addEventToTable(event) {
    const largeThreshold = parseFloat(largeThresholdInput.value) || 10000;
    const isLarge = event.volume > largeThreshold;
    
    if (isLarge) {
      largeLiquidations++;
      if (event.type === translations[currentLanguage].longLiq) {
        longLiquidations++;
      } else {
        shortLiquidations++;
      }
      
      // Trigger alert if enabled
      if (alertToggle.checked) {
        triggerAlert(event);
      }
    }
    
    // Ограничение размера массива событий
    if (events.length >= MAX_EVENTS) {
      events.shift();
    }
    
    events.push(event);
    
    // Частичная перерисовка таблицы
    renderTable();
  }

  // Trigger alert for large liquidation
  function triggerAlert(event) {
    try {
      // Play sound
      alertSound.currentTime = 0;
      alertSound.play().catch(e => console.log("Audio play failed:", e));
      
      // Show browser notification if supported
      if (Notification.permission === "granted") {
        new Notification(`${translations[currentLanguage].alertTitle} - ${event.symbol}`, {
          body: `${event.type} at $${event.price.toFixed(2)}\nVolume: $${event.volume.toFixed(0)}`,
          icon: "https://cdn-icons-png.flaticon.com/512/607/607870.png"
        });
      }
    } catch (e) {
      console.log("Alert failed:", e);
    }
  }

  // Функция форматирования цены с большим количеством знаков
  function formatPrice(price) {
    // Для цен > 1000 показываем 2 знака после запятой
    if (price > 1000) {
      return price.toFixed(2);
    }
    // Для цен > 1 показываем 4 знака
    if (price > 1) {
      return price.toFixed(4);
    }
    // Для мелких цен показываем до 8 знаков
    return price.toFixed(8).replace(/\.?0+$/, '');
  }

  // Render table with events
  function renderTable() {
    const showLongs = showLongsCheckbox.checked;
    const showShorts = showShortsCheckbox.checked;
    const minVolume = parseFloat(minVolumeInput.value) || 0;

    // Filter events based on checkboxes and min volume
    const filteredEvents = events.filter(event => {
      if (event.volume < minVolume) return false;
      if (event.type === translations[currentLanguage].longLiq && !showLongs) return false;
      if (event.type === translations[currentLanguage].shortLiq && !showShorts) return false;
      return true;
    });

    // Sort events
    filteredEvents.sort((a, b) => {
      if (sortField === "time") {
        return sortDirection === "asc" ? a.timestamp - b.timestamp : b.timestamp - a.timestamp;
      } else if (sortField === "price") {
        return sortDirection === "asc" ? a.price - b.price : b.price - a.price;
      } else if (sortField === "volume") {
        return sortDirection === "asc" ? a.volume - b.volume : b.volume - a.volume;
      } else if (sortField === "type") {
        return sortDirection === "asc" ? 
          a.type.localeCompare(b.type) : b.type.localeCompare(a.type);
      }
      return 0;
    });

    // Render table
    tableBody.innerHTML = '';
    filteredEvents.slice(0, MAX_EVENTS).forEach(event => {
      const largeThreshold = parseFloat(largeThresholdInput.value) || 10000;
      const isLarge = event.volume > largeThreshold;
      
      const row = document.createElement("tr");
      if (isLarge) {
        row.classList.add("large-volume", "large-liquidation");
        // Remove animation class after animation completes
        setTimeout(() => {
          row.classList.remove("large-liquidation");
        }, 2000);
      }
      row.innerHTML = `
        <td>${event.time}</td>
        <td>${event.type}</td>
        <td class="price-cell">${formatPrice(event.price)}</td>
        <td>$${formatNumber(event.volume)}</td>
      `;
      tableBody.appendChild(row);
    });
  }

  // Calculate liquidation price
  function calculateLiquidation() {
    const t = translations[currentLanguage];
    const entryPrice = parseFloat(entryPriceInput.value);
    const leverage = parseFloat(leverageInput.value);
    const positionType = positionTypeSelect.value;

    if (isNaN(entryPrice) || isNaN(leverage) || leverage < 1 || leverage > 100) {
      calcResultElement.textContent = t.invalidInput;
      calcResultElement.style.color = 'var(--danger)';
      return;
    }
    
    // Simplified liquidation price calculation
    const maintenanceMargin = 0.005; // 0.5%
    let liquidationPrice;
    
    if (positionType === 'long') {
      liquidationPrice = entryPrice * (1 - (1 / leverage) + maintenanceMargin);
    } else {
      liquidationPrice = entryPrice * (1 + (1 / leverage) - maintenanceMargin);
    }
    
    calcResultElement.innerHTML = `${t.liquidationPrice} <strong>${liquidationPrice.toFixed(4)}</strong>`;
    calcResultElement.style.color = 'var(--text-dark)';
  }

  // Update liquidity heatmap with REAL data
  async function updateLiquidityMap() {
    const symbol = symbolSelect.value.toUpperCase();
    const limit = 100; // Limit the number of levels for better visualization

    try {
        const response = await fetch(`https://api.binance.com/api/v3/depth?symbol=${symbol}&limit=${limit}`);
        if (!response.ok) {
            liquidityMapElement.innerHTML = 'Could not fetch liquidity data.';
            return;
        }
        const data = await response.json();

        // Asks are resistance levels (red), Bids are support levels (green)
        const asks = data.asks.map(level => ({ 
            price: parseFloat(level[0]), 
            volume: parseFloat(level[1]) * parseFloat(level[0]),
            type: 'ask'
        }));
        const bids = data.bids.map(level => ({ 
            price: parseFloat(level[0]), 
            volume: parseFloat(level[1]) * parseFloat(level[0]),
            type: 'bid'
        }));
        
        // Combine and sort by price descending
        const allLevels = [...asks, ...bids].sort((a, b) => b.price - a.price);
        if (allLevels.length === 0) return;

        const maxVolume = Math.max(...allLevels.map(level => level.volume));
        
        liquidityMapElement.innerHTML = ''; // Clear old map

        allLevels.forEach(level => {
            const levelElement = document.createElement('div');
            levelElement.className = 'liquidity-level';
            
            const widthPercentage = (level.volume / maxVolume * 100).toFixed(0);
            
            levelElement.innerHTML = `
                <div class="level-price">${formatPrice(level.price)}</div>
                <div class="level-bar">
                    <div class="level-fill" style="width: ${widthPercentage}%; background: ${level.type === 'ask' ? 'var(--short-color)' : 'var(--long-color)'};"></div>
                </div>
                <div class="level-volume">$${formatNumber(Math.round(level.volume))}</div>
            `;
            
            liquidityMapElement.appendChild(levelElement);
        });

    } catch (error) {
        console.error("Error fetching liquidity map data:", error);
        liquidityMapElement.innerHTML = 'Error loading data.';
    }
  }

  // Fetch open interest
  async function fetchOpenInterest(symbol) {
    try {
        const response = await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${symbol}`);
        if (!response.ok) {
            console.warn(`Could not fetch Open Interest for ${symbol}. It may not be a futures symbol.`);
            return;
        }
        const data = await response.json();
        openInterest = parseFloat(data.openInterest);
        updateStats();
    } catch (error) {
        console.error("Error fetching open interest:", error);
    }
  }

  // Connect to WebSocket
  function connect(symbol) {
    updateStatus(`${translations[currentLanguage].connecting} ${symbol}...`);
    // Закрытие предыдущего соединения
    if (socket) {
      socket.close();
    }
    
    const formattedSymbol = symbol.toLowerCase();
    try {
      socket = new WebSocket(`wss://fstream.binance.com/ws/${formattedSymbol}@aggTrade`);
    } catch (error) {
      updateStatus(`${translations[currentLanguage].connectionError} ${error}`, true);
      setTimeout(() => connect(symbol), 3000);
      return;
    }

    socket.onopen = () => {
      updateStatus(`${translations[currentLanguage].connected} ${symbol}`);
      startAggregationInterval(currentTimeframe);
      currentSymbolElement.textContent = symbol;
      
      fetchOpenInterest(symbol); 
      updateLiquidityMap(); 
    };

    socket.onmessage = (event) => {
      if (paused) return;
      
      // Защита от перегрузки
      const now = Date.now();
      if (now - lastReset > 1000) {
        eventCounter = 0;
        lastReset = now;
      }
      
      if (eventCounter > MAX_EVENTS_PER_SECOND) {
        console.warn("Event rate limit exceeded");
        return;
      }
      
      eventCounter++;

      try {
        const data = JSON.parse(event.data);
        // Process Binance data
        const price = parseFloat(data.p);
        const qty = parseFloat(data.q);
        const volume = price * qty;
        const type = data.m ? translations[currentLanguage].longLiq : translations[currentLanguage].shortLiq;
        const time = new Date(data.T).toLocaleTimeString();
        const minVolume = parseFloat(minVolumeInput.value) || 0;

        const eventObj = {
          symbol,
          time,
          type,
          price,
          volume,
          timestamp: data.T
        };

        // Add to table if volume passes filter
        if (eventObj.volume >= minVolume) {
          addEventToTable(eventObj);
        }

        // Update buffer for aggregation
        buffer.push({ 
          type,
          qty, 
          price,
          volume,
          timestamp: data.T
        });

        // Update stats
        updateStats();
      } catch (error) {
        console.error('Error processing message:', error);
      }
    };

    socket.onerror = (error) => {
      console.error('WebSocket error:', error);
      updateStatus(`${translations[currentLanguage].connectionError} ${error.message || 'Unknown'}`, true);
    };

    socket.onclose = (event) => {
      if (!paused && event.code !== 1000) {
        updateStatus(`${translations[currentLanguage].reconnecting} (${event.reason || 'Unknown'})`, true);
        setTimeout(() => connect(symbol), 3000);
      }
    };
  }

  // Initialize app
  async function init() {
    chart = initializeChart();
    // Request notification permission
    if (Notification.permission !== "granted") {
      try {
        await Notification.requestPermission();
      } catch (e) {
        console.log("Notification permission error:", e);
      }
    }
    
    try {
      updateStatus(translations[currentLanguage].loadingSymbols);
      const res = await fetch("https://api.binance.com/api/v3/exchangeInfo");
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      
      const data = await res.json();
      allSymbols = data.symbols
        .filter((s) => s.status === 'TRADING' && s.symbol.endsWith("USDT"))
        .map((s) => s.symbol);

      if (allSymbols.length === 0) throw new Error(translations[currentLanguage].noSymbols);

      renderSymbolOptions(allSymbols);

      const savedSymbol = localStorage.getItem("selectedSymbol");
      const initialSymbol = savedSymbol && allSymbols.includes(savedSymbol) 
        ? savedSymbol 
        : allSymbols[0];

      symbolSelect.value = initialSymbol.toLowerCase();
      currentSymbolIndex = allSymbols.indexOf(initialSymbol);
      connect(initialSymbol);
      updateStatus('');
    } catch (error) {
      updateStatus(`Error: ${error.message}`, true);
    }
  }

  // Render symbol options
  function renderSymbolOptions(symbols) {
    symbolSelect.innerHTML = symbols
      .map((sym) => `<option value="${sym.toLowerCase()}">${sym}</option>`)
      .join("");
  }

  // Sort table
  function sortTable(field) {
    if (sortField === field) {
      sortDirection = sortDirection === "asc" ? "desc" : "asc";
    } else {
      sortField = field;
      sortDirection = "desc";
    }
    
    // Update UI
    document.querySelectorAll('th').forEach(th => {
      th.classList.remove('sort-asc', 'sort-desc');
    });
    const header = document.querySelector(`th[data-sort="${field}"]`);
    if (header) {
      header.classList.add(`sort-${sortDirection}`);
    }
    
    renderTable();
  }

  // Export to CSV
  function exportToCSV() {
    if (events.length === 0) {
      alert(translations[currentLanguage].exportError);
      return;
    }
    
    const headers = ['Time', 'Type', 'Price', 'Volume (USD)'];
    const rows = events.map(event => [
      event.time,
      event.type,
      event.price,
      Math.round(event.volume)
    ]);
    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.join(','))
    ].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `liquidation_events_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // Navigate symbols
  function navigateSymbols(direction) {
    currentSymbolIndex += direction;
    if (currentSymbolIndex < 0) {
      currentSymbolIndex = allSymbols.length - 1;
    } else if (currentSymbolIndex >= allSymbols.length) {
      currentSymbolIndex = 0;
    }
    
    const symbol = allSymbols[currentSymbolIndex];
    symbolSelect.value = symbol.toLowerCase();
    // Trigger symbol change
    symbolSelect.dispatchEvent(new Event('change'));
  }

  // Save all settings
  function saveAllSettings() {
    const settings = {
      theme: document.body.classList.contains("light") ? "light" : "dark",
      language: currentLanguage,
      timeframe: currentTimeframe,
      minVolume: minVolumeInput.value,
      largeThreshold: largeThresholdInput.value,
      showLongs: showLongsCheckbox.checked,
      showShorts: showShortsCheckbox.checked,
      alertToggle: alertToggle.checked,
      symbol: symbolSelect.value.toUpperCase()
    };
    localStorage.setItem("appSettings", JSON.stringify(settings));
  }

  // Load all settings
  function loadAllSettings() {
    const savedSettings = localStorage.getItem("appSettings");
    if (savedSettings) {
      const settings = JSON.parse(savedSettings);

      // Apply settings
      if (settings.theme === "light") {
        document.body.classList.add("light");
        themeBtn.querySelector('i').className = 'fas fa-sun';
      }
      
      applyLanguage(settings.language || 'en');

      if (settings.timeframe) {
        timeframeSelect.value = settings.timeframe;
        currentTimeframe = parseInt(settings.timeframe);
      }
      
      minVolumeInput.value = settings.minVolume || 1000;
      largeThresholdInput.value = settings.largeThreshold || 10000;
      showLongsCheckbox.checked = settings.showLongs !== false;
      showShortsCheckbox.checked = settings.showShorts !== false;
      alertToggle.checked = settings.alertToggle || false;

      return settings.symbol;
    }
    return null;
  }

  // Event listeners
  symbolSearch.addEventListener("input", () => {
    const query = symbolSearch.value.toUpperCase();
    const filtered = allSymbols.filter((sym) => sym.includes(query));
    renderSymbolOptions(filtered);
  });

  symbolSelect.addEventListener("change", () => {
    const symbol = symbolSelect.value.toUpperCase();
    localStorage.setItem("selectedSymbol", symbol);
    currentSymbolIndex = allSymbols.indexOf(symbol);
    
    // Полный сброс данных
    tableBody.innerHTML = "";
    events = [];
    buffer = [];
    totalVolume = 0;
    buyVolume = 0;
    sellVolume = 0;
    largeLiquidations = 0;
    longLiquidations = 0;
    shortLiquidations = 0;
    heatmapData = [];
    openInterest = 0;
    
    clearTimeout(intervalTimer);
    intervalTimer = null;
    
    updateStats();
    initializeChart();
    updateHeatmap();
    updateLiquidityMap();
    
    // Переподключение
    connect(symbol);
    
    // Показать подсказку
    hintElement.style.display = 'flex';
    hintTextElement.textContent = translations[currentLanguage].hintText;
    
    // Save settings
    saveAllSettings();
  });

  minVolumeInput.addEventListener("change", () => {
    renderTable();
    saveAllSettings();
  });

  largeThresholdInput.addEventListener("change", () => {
    renderTable();
    saveAllSettings();
  });

  pauseBtn.addEventListener("click", () => {
    paused = !paused;
    
    if (paused) {
      pauseBtn.querySelector('span').textContent = translations[currentLanguage].resumeText;
      pauseBtn.querySelector('i').className = 'fas fa-play';
      
      // Закрытие сокета при паузе
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
      }
      clearTimeout(intervalTimer);
    } else {
      pauseBtn.querySelector('span').textContent = translations[currentLanguage].pauseText;
      pauseBtn.querySelector('i').className = 'fas fa-pause';
      connect(symbolSelect.value.toUpperCase());
    }
  });

  themeBtn.addEventListener("click", () => {
    document.body.classList.toggle("light");
    const isLight = document.body.classList.contains("light");
    themeBtn.querySelector('span').textContent = isLight ? translations[currentLanguage].themeText : translations[currentLanguage].themeText;
    themeBtn.querySelector('i').className = isLight ? 'fas fa-sun' : 'fas fa-moon';
    saveAllSettings();
    initializeChart();
  });

  clearBtn.addEventListener("click", () => {
    tableBody.innerHTML = "";
    events = [];
    buffer = [];
    totalVolume = 0;
    buyVolume = 0;
    sellVolume = 0;
    largeLiquidations = 0;
    longLiquidations = 0;
    shortLiquidations = 0;
    heatmapData = [];
    openInterest = 0;
    updateStats();
    initializeChart();
    updateHeatmap();
    updateLiquidityMap();
  });

  timeframeSelect.addEventListener("change", () => {
    const newTimeframe = parseInt(timeframeSelect.value);
    localStorage.setItem("timeframe", newTimeframe);
    
    // Сброс текущего интервала
    clearTimeout(intervalTimer);
    
    // Агрегация оставшихся данных
    aggregateBuffer();
    
    // Запуск нового интервала
    startAggregationInterval(newTimeframe);
    
    saveAllSettings();
  });

  showLongsCheckbox.addEventListener("change", () => {
    renderTable();
    saveAllSettings();
  });

  showShortsCheckbox.addEventListener("change", () => {
    renderTable();
    saveAllSettings();
  });
  
  alertToggle.addEventListener("change", saveAllSettings);
  
  exportBtn.addEventListener("click", exportToCSV);

  // Add sort handlers to table headers
  document.querySelectorAll('th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      sortTable(th.getAttribute('data-sort'));
    });
  });

  // Language selector
  languageBtn.addEventListener('click', () => {
    languageDropdown.classList.toggle('show');
  });

  document.querySelectorAll('.language-option').forEach(option => {
    option.addEventListener('click', () => {
      const lang = option.getAttribute('data-lang');
      applyLanguage(lang);
      languageDropdown.classList.remove('show');
      // Reinitialize chart to update labels
      initializeChart();
      saveAllSettings();
    });
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!languageBtn.contains(e.target) && !languageDropdown.contains(e.target)) {
      languageDropdown.classList.remove('show');
    }
  });

  // Symbol navigation
  prevSymbolBtn.addEventListener('click', () => navigateSymbols(-1));
  nextSymbolBtn.addEventListener('click', () => navigateSymbols(1));
  
  // Liquidation calculator
  calculateBtn.addEventListener('click', calculateLiquidation);

  // Initialize settings
  const savedSymbol = loadAllSettings();
  
  // Initialize language from localStorage if not set by settings
  if (!currentLanguage) {
    const savedLanguage = localStorage.getItem("language") || 'en';
    applyLanguage(savedLanguage);
  }
  
  // Initialize the app
  init();
  
  // Periodically update liquidity map
  setInterval(updateLiquidityMap, 10000);
</script>
</body>
</html>